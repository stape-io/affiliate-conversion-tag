___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Affiliate Conversion",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "This tag helps you setup the S2S conversion tracking for youraffiliate partners.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "RADIO",
    "name": "type",
    "displayName": "Type",
    "radioItems": [
      {
        "value": "page_view",
        "displayValue": "PageView"
      },
      {
        "value": "conversion",
        "displayValue": "Conversion"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "page_view",
    "help": "\u003cb\u003ePageView\u003c/b\u003e - stores URL parameter inside a cookie with the name: affiliate_{PARAMETER_NAME}\u003cbr\u003e\u003cbr\u003e\n\u003cb\u003eConversion\u003c/b\u003e - Send request to the desired URL"
  },
  {
    "type": "SELECT",
    "name": "urlSource",
    "displayName": "URL Source",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "page_location_default",
        "displayValue": "page_location"
      }
    ],
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "page_view",
        "type": "EQUALS"
      }
    ],
    "defaultValue": "page_location_default",
    "help": "Choose \u003cb\u003epage_location\u003c/b\u003e to use URL from \u003ca href\u003d\"https://developers.google.com/tag-manager/serverside/common-event-data\" target\u003d\"_blank\"\u003eCommon Event Data\u003c/a\u003e, or provide a variable that returns a valid URL string."
  },
  {
    "type": "TEXT",
    "name": "url",
    "displayName": "Destination URL",
    "simpleValueType": true,
    "valueHint": "https://",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "REGEX",
        "args": [
          "^https://.*"
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "conversion",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "requestMethod",
    "displayName": "Request Method",
    "selectItems": [
      {
        "value": "GET",
        "displayValue": "GET"
      },
      {
        "value": "POST",
        "displayValue": "POST"
      }
    ],
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "defaultValue": "GET",
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "conversion",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "clearCookies",
    "checkboxText": "Clear stored parameters on conversion",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "conversion",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "insideArray",
    "checkboxText": "Put request object inside the array.",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "requestMethod",
        "paramValue": "POST",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "urlParametersGroup",
    "displayName": "Url parameters to store",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "urlParameters",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Name",
            "name": "name",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "isUnique": true
          },
          {
            "defaultValue": "",
            "displayName": "Expiration in seconds (0 for session cookie)",
            "name": "expiration",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_NEGATIVE_NUMBER"
              }
            ]
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "page_view",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "urlDataGroup",
    "displayName": "Query parameters",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "urlData",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Key",
            "name": "key",
            "type": "TEXT",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "requestMethod",
        "paramValue": "GET",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "bodyDataGroup",
    "displayName": "JSON Request Body",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "LABEL",
        "name": "start",
        "displayName": "{"
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "bodyData",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Property",
            "name": "key",
            "type": "TEXT",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT"
          }
        ]
      },
      {
        "type": "LABEL",
        "name": "end",
        "displayName": "}"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "requestMethod",
        "paramValue": "POST",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "cookiesGroup",
    "displayName": "Stored parameters to clear",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "cookiesToClear",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Name",
            "name": "name",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "isUnique": true
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "clearCookies",
        "paramValue": true,
        "type": "EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const sendHttpRequest = require('sendHttpRequest');
const getEventData = require('getEventData');
const makeTableMap = require('makeTableMap');
const JSON = require('JSON');
const setCookie = require('setCookie');
const parseUrl = require('parseUrl');
const encodeUriComponent = require('encodeUriComponent');


if (data.type === 'page_view') {
    const parsedUrl = parseUrl(data.urlSource === 'page_location_default' ? getEventData('page_location') : data.urlSource);
    const urlParametersToStore = data.urlParameters && data.urlParameters.length ? data.urlParameters : [];

    urlParametersToStore.forEach(urlParameterToStore => {
        const name = urlParameterToStore.name;
        const value = parsedUrl && parsedUrl.searchParams ? parsedUrl.searchParams[urlParameterToStore.name] : '';

        if (value) {
            const options = {
                domain: 'auto',
                path: '/',
                secure: true,
                httpOnly: false
            };

            if (urlParameterToStore.expiration > 0) options['max-age'] = urlParameterToStore.expiration;

            setCookie('affiliate_'+name, value, options, false);
        }
    });

    data.gtmOnSuccess();
} else {
    let url = data.url;
    let postBodyData = '';
    let requestHeaders;

    if (data.clearCookies && data.cookiesToClear) {
        for (let key in data.cookiesToClear) {
            setCookie('affiliate_' + data.cookiesToClear[key].name, '', {
                domain: 'auto',
                path: '/',
                secure: true,
                httpOnly: false,
                'max-age': 10
            }, false);
        }
    }

    if (data.requestMethod === 'GET') {
        let urlParams = '';
        requestHeaders = {method: 'GET'};

        for (let key in data.urlData) {
            urlParams = urlParams ? urlParams + '&' + enc(data.urlData[key].key) + '=' + enc(data.urlData[key].value) : enc(data.urlData[key].key) + '=' + enc(data.urlData[key].value);
        }

        if (urlParams) {
            url = url.indexOf('?') !== -1 ? url + '&' + urlParams : url + '?' + urlParams;
        }
    } else {
        requestHeaders = {headers: {'Content-Type': 'application/json'}, method: 'POST'};
        postBodyData = data.bodyData ? makeTableMap(data.bodyData, 'key', 'value') : {};

        if (data.insideArray) {
            postBodyData = [postBodyData];
        }
    }

    sendHttpRequest(url, (statusCode, headers, body) => {
        if (statusCode >= 200 && statusCode < 300) {
            data.gtmOnSuccess();
        } else {
            data.gtmOnFailure();
        }
    }, requestHeaders, JSON.stringify(postBodyData));
}

function enc(data) {
    data = data || '';
    return encodeUriComponent(data);
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "affiliate_*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 10/11/2021, 09:29:27


